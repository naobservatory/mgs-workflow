nextflow_process {

    name "Test process PROCESS_VSEARCH_CLUSTER_OUTPUT"
    script "modules/local/processVsearchClusterOutput/main.nf"
    process "PROCESS_VSEARCH_CLUSTER_OUTPUT"
    config "tests/configs/run_dev_se.config"
    tag "module"
    tag "process_vsearch_cluster_output"

    setup {
        run("LOAD_SAMPLESHEET_DEV", alias: "LOAD_SAMPLESHEET") {
            script "subworkflows/local/loadSampleSheetDev/main.nf"
            process {
                """
                input[0] = "${projectDir}/test-data/single-end-samplesheet.csv"
                input[1] = "illumina"
                """
            }
        }
        run("VSEARCH_CLUSTER") {
            script "modules/local/vsearch/main.nf"
            process {
                """
                input[0] = LOAD_SAMPLESHEET.out.samplesheet
                input[1] = 0.95
                input[2] = 0
                input[3] = 15
                """
            }
        }
    }

    test("Should run without failures on valid inputs"){
        tag "expect_success"
        tag "single_end"
        when {
            params {}
            process {
                '''
                input[0] = VSEARCH_CLUSTER.out.summary
                '''
            }
        }
        then {
            // Should run without failures
            assert process.success
            // Sequence and cluster counts should match between input and output
            def tab_in = path(process.out.input[0][1]).csv(sep: "\t", decompress: true, header: false)
            def tab_out = path(process.out.output[0][1]).csv(sep: "\t", decompress: true)
            def n_clusters_in = tab_in.columns["C0"].count("C")
            def n_reps_in = tab_in.columns["C0"].count("S")
            def n_hits_in = tab_in.columns["C0"].count("H")
            def n_seqs_in = n_reps_in + n_hits_in
            def n_clusters_out = tab_out.columns["cluster_id"].unique().size()
            def n_reps_out = tab_out.columns["is_cluster_rep"].collect{it ? 1 : 0}.sum()
            def n_hits_out = tab_out.columns["is_cluster_rep"].collect{it ? 0 : 1}.sum()
            def n_seqs_out = n_reps_out + n_hits_out
            assert n_clusters_in == n_clusters_out
            assert n_reps_in == n_reps_out
            assert n_hits_in == n_hits_out
            assert n_seqs_in == n_seqs_out
            // Output should have expected dimensions and column headers
            def exp_col_names = ["seq_id", "cluster_id", "cluster_rep_id",
                "seq_length", "is_cluster_rep", "percent_identity",
                "orientation", "cigar", "cluster_size"]
            assert tab_out.rowCount == n_seqs_in
            assert tab_out.columnNames == exp_col_names
        }
    }
}
